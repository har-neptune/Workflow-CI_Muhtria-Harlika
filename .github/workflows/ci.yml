name: ML Training CI Pipeline

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  train:
    runs-on: ubuntu-latest

    steps:
    # 1. Set up job
    - name: Set up job
      run: echo "Starting ML CI Pipeline"

    # 2. Checkout repository
    - name: Checkout repository
      uses: actions/checkout@v3

    # 3. Set up Python
    - name: Set up Python 3.12
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    # 4. Check Env
    - name: Check Env
      run: |
        python --version
        pip --version

    # 5. Install dependencies
    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install mlflow dagshub scikit-learn pandas numpy matplotlib seaborn

    # 6. Run MLflow Project (training)
    - name: Run mlflow project
      run: |
        cd MLProject
        mlflow run . --env-manager=local

    # 7. Get latest MLflow run id
    - name: Get latest MLflow run id
      run: |
        RUN_ID=$(ls -td MLProject/mlruns/*/* | head -n 1 | awk -F'/' '{print $(NF)}')
        echo $RUN_ID > run_id.txt
        echo "RUN_ID=$RUN_ID"

    # 8. Install Python dependencies (post-run)
    - name: Install Python dependencies
      run: |
        pip install mlflow docker

    # 9. Upload to Google Drive (using GitHub Artifacts)
    - name: Upload to GitHub Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: mlflow-artifacts
        path: |
          MLProject/mlruns

    # 10. Build Docker Model
    - name: Build Docker Model
      run: |
        cd MLProject
        RUN_ID=$(cat ../run_id.txt)
        mlflow models build-docker \
          -m runs:/$RUN_ID/model \
          -n ${{ secrets.DOCKERHUB_USERNAME }}/world-happiness-ml

    # 11. Log in to Docker Hub
    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    # 12. Tag Docker Image
    - name: Tag Docker Image
      run: |
        docker tag \
          ${{ secrets.DOCKERHUB_USERNAME }}/world-happiness-ml:latest \
          ${{ secrets.DOCKERHUB_USERNAME }}/world-happiness-ml:ci

    # 13. Push Docker Image
    - name: Push Docker Image
      run: |
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/world-happiness-ml:latest
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/world-happiness-ml:ci

    # 14. Post Log in to Docker Hub
    - name: Post Log in to Docker Hub
      run: echo "Docker image pushed successfully"

    # 15. Post Set up Python
    - name: Post Set up Python
      run: echo "Python setup completed"

    # 16. Post Run actions/checkout
    - name: Post Run actions/checkout
      run: echo "Checkout completed"

    # 17. Complete job
    - name: Complete job
      run: echo "ML Training CI Pipeline Completed Successfully"
